<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Pascal WEB Compiler Prototype</title>
    <script type="text/javascript" src="edit_area/edit_area_full.js"></script>
    <!--<script type="text/javascript" src="../PascalWEBCompiler/edit_area/edit_area_full.js"></script>-->
    <script type="text/javascript">
        // initialisation
        editAreaLoader.init({
            id: "example_1"	// id of the textarea to transform
            , start_highlight: true	// if start with highlight
            , allow_resize: "both"
            , allow_toggle: true
            , word_wrap: true
            , language: "ru"
            , syntax: "pas"
            , toolbar: "search, go_to_line, |, undo, redo, |, select_font, |, change_smooth_selection, highlight, reset_highlight, |, help"
            , EA_load_callback: "editAreaLoaded"
            , show_line_colors: true
            , font_size: "12"
            , font_family: "verdana, monospace"
            , allow_resize: "y"
            , load_callback: "my_load"
            , save_callback: "my_save"
            , plugins: "charmap"
            , charmap_default: "arrows"
            , min_height: 350
        });

        // callback functions
        function my_save(id, content) {
            alert("Here is the content of the EditArea '" + id + "' as received by the save callback function:\n" + content);
        }

        function my_load(id) {
            editAreaLoader.setValue(id, "The content is loaded from the load_callback function into EditArea");
        }

        function test_setSelectionRange(id) {
            editAreaLoader.setSelectionRange(id, 100, 150);
        }

        function test_getSelectionRange(id) {
            var sel = editAreaLoader.getSelectionRange(id);
            alert("start: " + sel["start"] + "\nend: " + sel["end"]);
        }

        function test_setSelectedText(id) {
            text = "[REPLACED SELECTION]";
            editAreaLoader.setSelectedText(id, text);
        }

        function test_getSelectedText(id) {
            alert(editAreaLoader.getSelectedText(id));
        }

        function editAreaLoaded(id) {
            if (id == "example_2") {
                open_file1();
                open_file2();
            }
        }


        function toogle_editable(id) {
            editAreaLoader.execCommand(id, 'set_editable', !editAreaLoader.execCommand(id, 'is_editable'));
        }

    </script>
    <link href="index.css" rel="stylesheet" type="text/css" />
</head>
<body>
    <h1>Pascal WEB Compiler</h1>
    <nav>
        <menu>
            <li> <a>Заголовок 1</a> <a>Заголовок 2</a> </li>
        </menu>
    </nav>
    <form id="auth_form" onSubmit="auth();return false">
        <input id="username" name="username" placeholder="Имя пользователя" />
        <br />
        <br />
        <input id="password" name="password" type="password" placeholder="Пароль" />
        <button type="submit" onClick="auth()">Вход</button>
        <button type="button" onClick="signup()">Регистрация</button>
        <br />
        <br />
        <div id="signin_result"></div>
    </form>
    <form action="" method="post">
        <fieldset>
            <legend>Code Area</legend>
            <input type="file" id="filename"/> 
            <br/>
            <br/>
            <textarea class="textarea1" id="example_1" name="test_1">
//Simple example
var a,b,c:integer;
begin
	a:=2;
	b:=3;
	c:=4;
	writeln(sqr(a)+b*c);
end.
		    </textarea>
            <p>
                Custom controls: <br />
                <input type='button' onclick='alert(editAreaLoader.getValue("example_1"));' value='get value' />
                <input type='button' onclick='editAreaLoader.setValue("example_1", "new_value");' value='set value' />
                <input type='button' onclick='test_getSelectionRange("example_1");' value='getSelectionRange' />
                <input type='button' onclick='test_setSelectionRange("example_1");' value='setSelectionRange' />
                <input type='button' onclick='test_getSelectedText("example_1");' value='getSelectedText' />
                <input type='button' onclick='test_setSelectedText("example_1");' value='setSelectedText' />
                <input type='button' onclick='editAreaLoader.insertTags("example_1", "[OPEN]", "[CLOSE]");' value='insertTags' />
                <input type='button' onclick='toogle_editable("example_1");' value='Toggle readonly mode' />
            </p>
            <p>
                <input type="button" onclick='sendCode("example_1");' value="Отправить" />
            </p>

            <!-- div с сообщениями -->
            <div id="compiler_messages"></div>
        </fieldset>
    </form>
</body>
<script>
    const socket = new WebSocket("ws://nodejs-webcompiler-server.herokuapp.com:80");//, {perMessageDeflate: false});
    var form = document.forms['form'];
    let auth_hash = getCookie('hash');
    socket.onopen = function () {
        console.log('подключился');
    };

    function getCookie(name) {
        let matches = document.cookie.match(new RegExp(
            "(?:^|; )" + name.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g, '\\$1') + "=([^;]*)"
        ));
        return matches ? decodeURIComponent(matches[1]) : undefined;
    }

    // Пример использования:
    //setCookie('user', 'John', {secure: true, 'max-age': 3600});
    function setCookie(name, value, options = {}) {
        options = {
            path: '/',
            // при необходимости добавьте другие значения по умолчанию
            ...options
        };

        if (options.expires instanceof Date) {
            options.expires = options.expires.toUTCString();
        }

        let updatedCookie = encodeURIComponent(name) + "=" + encodeURIComponent(value);
        for (let optionKey in options) {
            updatedCookie += "; " + optionKey;
            let optionValue = options[optionKey];
            if (optionValue !== true) {
                updatedCookie += "=" + optionValue;
            }
        }
        document.cookie = updatedCookie;
    }

    function auth() {
        socket.send(JSON.stringify({ action: 'AUTH_LOGIN', login: auth_form.username.value, password: auth_form.password.value }));
    };
    function signup() {
        //if 
        socket.send(JSON.stringify({ action: 'SIGNUP', login: auth_form.username.value, password: auth_form.password.value }));
    };
    function changediv(elem, message) {
        var changer = document.querySelector(elem);
        changer.textContent = message;
    };

    function wsSendEcho(value) {
        socket.send(JSON.stringify({ action: 'ECHO', data: '123' }));
    };

    function wsSendPing() {
        socket.send(JSON.stringify({ action: 'PING' }));
    };

    socket.onclose = function (event) {
        if (event.wasClean) {
            alert(`[close] Соединение закрыто чисто, код=${event.code} причина=${event.reason}`);
        } else {
            // например, сервер убил процесс или сеть недоступна
            // обычно в этом случае event.code 1006
            alert('[close] Соединение прервано');
        }
    };

    socket.onerror = function (error) {
        alert(`[error] ${error.message}`);
    };

    // отправка сообщения из формы
    function sendCode(event) {
        changediv('#compiler_messages', 'Wait...');
        let outgoingMessage = this.editAreaLoader.getValue("example_1");
        //let filename = document.querySelector();
        socket.send(JSON.stringify({ action: 'CODE', filename: 'filename', data: outgoingMessage, hash: getCookie('hash') }));
        //alert('Message send');
        //alert(outgoingMessage);
        return;
    };
    var socket1 = [];
    async function testConnections(iterator) {
        socket1[iterator] = new WebSocket("ws://nodejs-webcompiler-server.herokuapp.com:80")l;//, {perMessageDeflate: false});
        socket1[iterator].onopen = function () {
            const start = Date.now();
            let outgoingMessage = editAreaLoader.getValue("example_1");
            //socket1[iterator].send(JSON.stringify({ action: 'CODE', data: outgoingMessage, filename: iterator, hash: getCookie('hash')}));
            socket1[iterator].send(JSON.stringify({action: 'PING'}))
            const duration = Date.now() - start;
            console.log(`send ${iterator} packet with ${duration}`);
        }
    }

    socket.onmessage = function (event) {
        let input_message;
        try {
            input_message = JSON.parse(event.data);
            switch (JSON.parse(event.data).action) {
                case 'HELLO':
                    changediv('#compiler_messages', input_message.data);
                    getCookie('hash') === undefined ? socket.send(JSON.stringify({ action: 'GUEST_AUTH' })) : socket.send(JSON.stringify({ action: '', hash: ''}));
                    break;

                case 'GUEST_AUTH_OK':
                    setCookie('hash', input_message.hash, { 'max-age': 86400 })
                    //
                    break;

                case 'LOGIN_CORRECT':
                    //document.getElementById('auth_form').delete;
                    setCookie('hash', input_message.hash, { 'max-age': 31536000 })
                    break;

                case 'LOGIN_INCORRECT':
                    changediv('#signin_result', 'Login or password incorrect')
                    document.getElementById('auth_form').reset();
                    break;

                case 'SIGNUP_LOGIN_USED':
                    changediv('#signin_result', 'This login already in use')
                    document.getElementById('auth_form').reset();
                    break;

                case 'SIGNUP_SUCCESSFUL':
                    //document.cookie set JSON.parse(event.data).hash
                    socket.send(JSON.stringify({ action: 'AUTH_COOKIE', hash: JSON.parse(event.data).hash }));
                    setCookie('hash', JSON.parse(event.data).hash, { 'max-age': 31536000 })
                    break;

                case 'COMPILER_ANSWER':
                    changediv('#compiler_messages', input_message.data);
                    break;
            }
        } catch (e) {
            console.log(`Error: ${e}`);
            changediv('#compiler_messages', event.data);
        }

        console.log('MessageFULL: %s', event.origin, "0 ", "1 ", input_message.data, "2 ", event.data, "3 ", event.action);
        console.log('Message: %s', input_message.data);
        //let messageElem = document.createElement('div');
        //messageElem.textContent = message;
        //document.getElementById('compiler_messages').value = message;
        //document.getElementById('compiler_messages').prepend(messageElem);
    };
</script>
</html>
