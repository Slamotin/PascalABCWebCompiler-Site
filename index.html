<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Pascal WEB Compiler Prototype</title>
    <script type="text/javascript" src="edit_area/edit_area_full.js"></script>
    <!--<script type="text/javascript" src="../PascalWEBCompiler/edit_area/edit_area_full.js"></script>-->
    <script type="text/javascript">
        // initialisation
        editAreaLoader.init({
            id: "example_1"	// id of the textarea to transform
            , start_highlight: true	// if start with highlight
            , allow_resize: "both"
            , allow_toggle: true
            , word_wrap: true
            , language: "ru"
            , syntax: "pas"
            , toolbar: "new_document, save, load, |, search, go_to_line, |, undo, redo, |, select_font, |, change_smooth_selection, highlight, reset_highlight, |, help"
            , is_multi_files: true
            , EA_load_callback: "editAreaLoaded"
            , show_line_colors: true
            , font_size: "12"
            , font_family: "verdana, monospace"
            , load_callback: "my_load"
            , save_callback: "my_save"
            , change_callback: "my_change_callback"
            , plugins: "charmap"
            , charmap_default: "arrows"
            , min_height: 350
            , debug: true
        });

        var textAreaID = "example_1";

        // callback functions
        function my_save(id, textarea_content) {
            let code = this.editAreaLoader.getCurrentFile(textAreaID);
            trySend(JSON.stringify({ action: "SAVE_FILE", data: code.text, hash: getCookie("hash"), filename: code.title, raw_string: code }));

            sessionStorage.removeItem(code.title);
            setTimeout(() => getAllFiles(), 1000);
        }

        function my_load(id) {
            editAreaLoader.setValue(id, "The content is loaded from the load_callback function into EditArea");
        }

        function my_change_callback(id) {
            let code = this.editAreaLoader.getCurrentFile(textAreaID);
            sessionStorage.setItem(code.title, JSON.stringify(code));
        }

        function test_setSelectionRange(id) {
            editAreaLoader.setSelectionRange(id, 100, 150);
        }

        function test_getSelectionRange(id) {
            var sel = editAreaLoader.getSelectionRange(id);
            alert("start: " + sel["start"] + "\nend: " + sel["end"]);
        }

        function test_setSelectedText(id) {
            text = "[REPLACED SELECTION]";
            editAreaLoader.setSelectedText(id, text);
        }

        function test_getSelectedText(id) {
            alert(editAreaLoader.getSelectedText(id));
        }

        function editAreaLoaded(id) {
            //open_file1(id);
            for (let iter = 0; iter < sessionStorage.length; iter++){
                editAreaLoader.openFile(textAreaID, JSON.parse(sessionStorage.getItem(sessionStorage.key(iter))));
            }
        }

        function openSample(){
            let new_file = { id: "empty_file.pas", text: '//Simple example\nvar a,b,c:integer;\nbegin\n\ta:=2;\n\tb:=3;\n\tc:=4;\n\twriteln(sqr(a)+b*c);\nend.'};
			editAreaLoader.openFile(textAreaID, new_file);
        }
        function toogle_editable(id) {
            editAreaLoader.execCommand(id, 'set_editable', !editAreaLoader.execCommand(id, 'is_editable'));
        }
    </script>
    <link href="index.css" rel="stylesheet" type="text/css" />
</head>
<body>
<!--
    <header class="topnav">
        <h1>Pascal WEB Compiler</h1>
        <a href="#home" class="active">Home</a>
        <button class="user_menu">
            Login or Sign Up 
            <i class="fa-caret-down">
            </i>
        </button>
        <div class="dropdown-content">
            <a>Link1</a>
        </div>
        <a href="#news">News</a>
        <div class="dropdown">
          <button class="dropbtn">Dropdown</button>
          <div class="dropdown-content">
                <a href="#">Link 1</a>
                <a href="#">Link 2</a>
                <a href="#">Link 3</a>
          </div>
        </div>
    </header>
    <br />
    <br />
    <nav>
        <menu>
            <li> <a>Заголовок 1</a> <a>Заголовок 2</a> </li>
        </menu>
    </nav>
-->

    <form id="auth_form" onSubmit="auth();return false">
        <input id="username" name="username" placeholder="Имя пользователя" />
        <br />
        <br />
        <input id="password" name="password" type="password" placeholder="Пароль" />
        <button type="submit" onClick="auth()">Вход</button>
        <button type="button" onClick="signup()">Регистрация</button>
        <br />
        <br />
        <div><input type="checkbox" id="saveMyAuth" /><label for="saveMyAuth">Запомнить меня</label></div>
        <br />
        <br />
        <div id="signin_result"></div>
    </form>
    <div class="root">
        <form action="" method="post">
            <fieldset>
                <legend>Code Area</legend>
                <input type="file" id="filename" />
                <input type="text" id="fileNameFolder" />
                <button type="button" id="changeFileName" onClick="changeFileName(fileNameFolder.value)">Изменить имя файла</button>
                <br />
                <br />
                <textarea class="textarea1" id="example_1" name="test_1"></textarea>
                <textarea class="compiler_answers" readonly=readonly>
                
                ssdasfsafasfasfas
                </textarea>
                <p>
                    Custom controls: <br />
                    <input type='button' onclick='alert(editAreaLoader.getValue("example_1"));' value='get value' />
                    <input type='button' onclick='editAreaLoader.setValue("example_1", "new_value");' value='set value' />
                    <input type='button' onclick='test_getSelectionRange("example_1");' value='getSelectionRange' />
                    <input type='button' onclick='test_setSelectionRange("example_1");' value='setSelectionRange' />
                    <input type='button' onclick='test_getSelectedText("example_1");' value='getSelectedText' />
                    <input type='button' onclick='test_setSelectedText("example_1");' value='setSelectedText' />
                    <input type='button' onclick='editAreaLoader.insertTags("example_1", "[OPEN]", "[CLOSE]");' value='insertTags' />
                    <input type='button' onclick='toogle_editable("example_1");' value='Toggle readonly mode' />
                </p>
                <p>
                    <input type="button" onclick='sendCode("example_1");' value="Отправить" />
                </p>

                <!-- div с сообщениями -->
                <div id="compiler_messages"></div>
            </fieldset>
        </form>
        <aside id="files_side">
                <h2>Файлы</h2>
                <form action="alert(value);" id="file_form">
                    <p>
                        <select id="file_list" multiple="multiple">
                        </select>
                    </p>
                    <button type="button" id="openFileButton" onClick="openFileBySelect(file_list.selectedOptions[0].innerText)">Открыть</button>
                    <button type="button" id="deleteSelectedFile" onClick="deleteFile(file_list.selectedOptions[0].innerText)">Удалить</button>
                </form>
        </aside>
    </div>
</body>
<script>
    function getCookie(name) {
        let matches = document.cookie.match(new RegExp(
            "(?:^|; )" + name.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g, '\\$1') + "=([^;]*)"
        ));
        return matches ? decodeURIComponent(matches[1]) : undefined;
    }

    // Пример использования:
    //setCookie('user', 'John', {secure: true, 'max-age': 3600});
    function setCookie(name, value, options = {}) {
        options = {
            path: '/',
            // при необходимости добавьте другие значения по умолчанию
            ...options
        };

        if (options.expires instanceof Date) {
            options.expires = options.expires.toUTCString();
        }

        let updatedCookie = encodeURIComponent(name) + "=" + encodeURIComponent(value);
        for (let optionKey in options) {
            updatedCookie += "; " + optionKey;
            let optionValue = options[optionKey];
            if (optionValue !== true) {
                updatedCookie += "=" + optionValue;
            }
        }
        document.cookie = updatedCookie;
    }
    var messageQueue = [];
    function trySend(jsonString) {
        if (socket.readyState === 2 || socket.readyState === 3) {
            connectToServer();
        }
        if (socket.readyState !== 1) {
            messageQueue.push(jsonString);
        } else {
            socket.send(jsonString);
        }
        console.log("Send: " + jsonString)
    }

    function auth() {
        trySend(JSON.stringify({ action: 'AUTH_LOGIN', login: auth_form.username.value, password: auth_form.password.value }));
    };
    function signup() {
        trySend(JSON.stringify({ action: 'SIGNUP', login: auth_form.username.value, password: auth_form.password.value }));
    };
    function changediv(elem, message) {
        var changer = document.querySelector(elem);
        changer.textContent = message;
    };

    function wsSendEcho(value) {
        socket.send(JSON.stringify({ action: 'ECHO', data: '123' }));
    };

    function wsSendPing() {
        socket.send(JSON.stringify({ action: 'PING' }));
    };

    // отправка сообщения из формы
    function sendCode(event) {
        changediv('#compiler_messages', 'Wait...');
        let code = this.editAreaLoader.getCurrentFile(textAreaID);

        trySend(JSON.stringify({ action: 'COMPILE_CODE', data: code.text, hash: getCookie("hash"), filename: code.title, raw_string: code }));
        //let filename = document.querySelector();
        //alert('Message send');
        //alert(outgoingMessage);
        return;
    };

    function checkLocalStorage() {
        for (let iter in this.editAreaLoader.getAllFiles(textAreaID)) {
            if (localStorage.getItem(iter.title) != null) {
                this.editAreaLoader.openFile(textAreaID, JSON.parse(localStorage.getItem(iter.title)));
            }
        }
    }

    /*async function readOpenedFiles() {
        trySend(JSON.stringify({ action: 'GET_OPENED_FILES', hash: getCookie('hash') }));
    }*/

    async function addFileToFilelist(filename, raw_string) {
        let contains = [];
        for (let elem of document.getElementById('file_list').children) {
            contains.push(elem.innerText)
        }
        //if (document.getElementById('file_list'))
        if (!contains.includes(filename)) {
            let newOptionNode = document.createElement('option');
            newOptionNode.innerText = filename;
            newOptionNode.ondblclick = function () { openFileBySelect(this.innerText); };
            //newOptionNode.addEventListener(ondblclick, openFileBySelect)
            document.getElementById('file_list').appendChild(newOptionNode);
        }
        
        //sessionStorage.setItem(filename, raw_string);
    }

    function openFileBySelect(filename) {
        if (file_list.selectedOptions[0] == undefined) {
            changediv('#compiler_messages', 'No one selected file')
        } else {
            trySend(JSON.stringify({ action: 'GET_FILE', hash: getCookie('hash'), filename: filename }));
        }
    }

    function getAllFiles() { //when we auth we get all files
        trySend(JSON.stringify({ action: 'AUTH_COOKIE', hash: getCookie('hash') }));
    }

    function openNewFile() {
        let filename = 'new_file';
        let number = 0;
        let used_numbers = [];
        for (let iter of file_list) {
            let parsed_line = iter.innerText.split(/(\d+)/)
            let n = parseInt(parsed_line[1])
            if (parsed_line[0] == filename) {
                used_numbers.push(n);
            }
        };
        while (true) {
            let aaa = used_numbers.indexOf(number);
            if (used_numbers.indexOf(number) != -1) {
                number++;
            } else {
                break;
            }
        }
        editAreaLoader.openFile(textAreaID, { id: filename + number + '.pas' })
        my_save(textAreaID, '');
        setTimeout(()=>getAllFiles(), 1000);
    }

    function deleteFile(filename) {
        
        if (file_list.selectedOptions[0] == undefined) {
            changediv('#compiler_messages', 'No one selected file')
        } else {
            file_list.selectedOptions[0].remove()
            trySend(JSON.stringify({ action: 'DELETE_FILE', hash: getCookie('hash'), filename: filename }));
            this.editAreaLoader.closeFile(textAreaID, filename);
        }
    }

    function changeFileName(filename) {
        
    }

    var socket1 = [];
    async function testConnections(iterator) {
        socket1[iterator] = new WebSocket("wss://nodejs-webcompiler-server.herokuapp.com:443");
        socket1[iterator].onopen = function () {
            const start = Date.now();
            let outgoingMessage = editAreaLoader.getValue("example_1");
            //socket1[iterator].send(JSON.stringify({ action: 'CODE', data: outgoingMessage, filename: iterator, hash: getCookie('hash')}));
            socket1[iterator].send(JSON.stringify({ action: 'PING' }))
            const duration = Date.now() - start;
            console.log(`send ${iterator} packet with ${duration}`);
        }
    }

    var socket;
    var input_message;
    function connectToServer() {
        socket = new WebSocket("wss://nodejs-webcompiler-server.herokuapp.com:443");
        var form = document.forms['form'];
        let auth_hash = getCookie('hash');

        socket.onopen = function () {
            console.log('подключился');
            while (messageQueue.length > 0) {
                socket.send(messageQueue.pop());
            }
        };

        socket.onclose = function (event) {
            if (event.wasClean) {
                //alert(`[close] Соединение закрыто чисто, код=${event.code} причина=${event.reason}`);
                changediv('#compiler_messages', 'Соединение закрыто чисто')
            } else {
                // например, сервер убил процесс или сеть недоступна
                // обычно в этом случае event.code 1006
                //alert('[close] Соединение прервано');
                changediv('#compiler_messages', 'Соединение с сервером оборвано')
            }
        };

        socket.onerror = function (error) {
            alert(`[error] ${error.message}`);
        };

        socket.onmessage = function (event) {
            try {
                input_message = JSON.parse(event.data);
                switch (input_message.action) {
                    case 'HELLO':
                        changediv('#compiler_messages', input_message.data);
                        getCookie('hash') === undefined ? socket.send(JSON.stringify({ action: 'NEW_GUEST' })) : socket.send(JSON.stringify({ action: 'AUTH_COOKIE', hash: getCookie('hash') }));
                        break;
                    case 'AUTH_OK': {
                        //change auth_form
                        let a = document.createElement('a');
                        a.innerText = 'Привет, ' + input_message.nickname;
                        //a.margin
                        auth_form.after(a);
                        auth_form.style.display == 'none';
                        //change file_form
                        let files = JSON.parse(input_message.files);
                        for (let f of files.rows) {
                            addFileToFilelist(f.filename, f.raw_string);
                        }
                        file_list.lastElementChild.selected = true;
                        openFileBySelect(file_list.value);
                        //readOpenedFiles();
                        checkLocalStorage();
                        break;
                    }

                    case 'GUEST_AUTH_OK': {
                        //change file_form
                        let files = JSON.parse(input_message.files);
                        for (let f of files.rows) {
                            addFileToFilelist(f.filename, f.raw_string);
                        }
                        file_list.lastElementChild.selected = true;
                        openFileBySelect(file_list.value);
                        //readOpenedFiles();
                        checkLocalStorage();
                        break;
                    }
                    case 'NEW_GUEST_REGISTRATION_OK':
                        setCookie('hash', input_message.hash, { 'max-age': 86400 });
                        //open sample file
                        openSample();
                        my_save(textAreaID, '');
                        trySend(JSON.stringify({ action: 'AUTH_COOKIE', hash: getCookie('hash') }));
                        break;

                    case 'LOGIN_CORRECT':
                        //document.getElementById('auth_form').delete;
                        if (document.getElementById("saveMyAuth").checked) {
                            //renew cookie lifetime
                            setCookie('hash', input_message.hash, { 'max-age': 31536000 });
                        } else {
                            //save hash only in session
                            setCookie('hash', input_message.hash);
                        }
                        //read from server opened files
                        //readOpenedFiles();
                        //read local storage
                        checkLocalStorage();
                        break;

                    case 'LOGIN_INCORRECT':
                        changediv('#signin_result', 'Login or password incorrect')
                        document.getElementById('auth_form').reset();
                        break;
                    case 'TOKEN_NOT_VALID':{
                        //delete hash
                        setCookie('hash','', {'max-age': -1})
                        changediv('#compiler_messages', 'Your token not valid or expired, please refresh page or use sign in form')
                        break;
                    }
                    case 'SIGNUP_LOGIN_USED':
                        changediv('#signin_result', 'This login already in use')
                        document.getElementById('auth_form').reset();
                        break;

                    case 'SIGNUP_SUCCESSFUL':
                        //document.cookie set JSON.parse(event.data).hash
                        //socket.send(JSON.stringify({ action: 'AUTH_COOKIE', hash: JSON.parse(event.data).hash }));
                        //setCookie('hash', JSON.parse(event.data).hash, { 'max-age': 31536000 })
                        changediv('#signin_result', 'Registration complete! Now you can enter to account.')
                        break;

                    case 'SAVE_FILE_OK': {
                        changediv('#compiler_messages', input_message.data);
                        localStorage.removeItem(input_message.filename);
                        break;
                    }

                    case 'TAKE_FILE': {
                        let file = JSON.parse(input_message.raw_string)
                        console.log('File: ' + file.rows[0].raw_string)
                        console.log('Take file: ' + JSON.parse(file.rows[0].raw_string).title);
                        editAreaLoader.openFile(textAreaID, JSON.parse(file.rows[0].raw_string));
                        break;
                    }

                    case 'DELETE_SUCCESSFUL': {
                        changediv('#compiler_messages', 'Delete completed')
                        break;
                    }

                    /*case 'GET_OPENED_FILES_OK': {
                        //open all files in resolve
                        let res = JSON.parse(input_message.data);
                        for (let i of res) {
                            this.editAreaLoader.openFile(textAreaID, res.raw_string)
                        }
                        break;
                    }

                    case 'NO_OPENED_FILES': {
                        //what name set for new file?
                        this.editAreaLoader.openFile(textAreaID, { id: 'new_file.pas', title: 'new_file.pas', text: '//new file'})
                        //open new file
                        break;
                    }*/

                    case 'COMPILER_ANSWER':
                        changediv('#compiler_messages', input_message.data);
                        break;
                }
            } catch (e) {
                console.log(`Error: ${e}`);
                changediv('#compiler_messages', event.data);
            }

            console.log('MessageFULL: %s', event.origin, "0 ", "1 ", input_message.data, "2 ", event.data, "3 ", event.action);
            console.log('Message: %s', input_message.data);
            //let messageElem = document.createElement('div');
            //messageElem.textContent = message;
            //document.getElementById('compiler_messages').value = message;
            //document.getElementById('compiler_messages').prepend(messageElem);
        };
    }

    connectToServer();
</script>
</html>
